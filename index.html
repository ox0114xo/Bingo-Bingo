<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Bingo æ™ºèƒ½çµ‚ç«¯ (ç›´é€£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tc-red { color: #E63946; }
        .tc-bg-red { background-color: #E63946; }
        .tc-bg-dark { background-color: #0A1931; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-20">

    <div class="tc-bg-dark text-white p-4 shadow-md sticky top-0 z-50">
        <h1 class="text-2xl font-bold text-center mb-2">ğŸ° Bingo Bingo æ™ºèƒ½çµ‚ç«¯</h1>
        <div class="flex justify-center items-center gap-4 text-xl">
            <span>â³ ä¸‹æœŸé–‹çå€’æ•¸ï¼š</span>
            <span id="timer" class="text-yellow-400 font-mono font-bold text-2xl">--:--</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4 space-y-6 mt-4">
        
        <div id="status-box" class="p-3 rounded-lg bg-gray-200 text-center font-bold shadow animate-pulse">
            ğŸ”„ æ­£åœ¨é€é Google è©¦ç®—è¡¨é€£ç·šè®€å–è³‡æ–™...
        </div>

        <div class="bg-white p-4 rounded-xl shadow border-t-4 border-red-500">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-xl font-bold tc-red">ğŸ“Š æœ€æ–°é–‹çè™Ÿç¢¼</h2>
                <button onclick="fetchGoogleSheetData()" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">ğŸ”„ ç«‹å³åˆ·æ–°</button>
            </div>
            <div id="draws-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow border-t-4 border-blue-900">
            <h2 class="text-xl font-bold mb-4 text-blue-900 border-b pb-2">ğŸ“ æŠ•æ³¨èˆ‡å°çè©¦ç®— (æ˜Ÿè™Ÿç©æ³•)</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-bold mb-1">ç©æ³•(æ˜Ÿæ•¸)</label>
                    <select id="star-select" class="w-full border p-2 rounded bg-gray-50">
                        <option value="1">1 æ˜Ÿ</option><option value="2">2 æ˜Ÿ</option><option value="3" selected>3 æ˜Ÿ</option>
                        <option value="4">4 æ˜Ÿ</option><option value="5">5 æ˜Ÿ</option><option value="6">6 æ˜Ÿ</option>
                        <option value="7">7 æ˜Ÿ</option><option value="8">8 æ˜Ÿ</option><option value="9">9 æ˜Ÿ</option><option value="10">10 æ˜Ÿ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">å€æ•¸</label>
                    <input type="number" id="multiplier" value="4" min="1" class="w-full border p-2 rounded bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">é€£çºŒæœŸæ•¸</label>
                    <input type="number" id="draw-counts" value="10" min="1" class="w-full border p-2 rounded bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">èµ·å§‹æœŸæ•¸</label>
                    <input type="text" id="start-draw" placeholder="ä¾‹: 115011756" class="w-full border p-2 rounded bg-gray-50">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">è¼¸å…¥è™Ÿç¢¼ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: 5, 12, 66)</label>
                <input type="text" id="user-numbers" placeholder="è¼¸å…¥é¸è™Ÿ..." class="w-full border-2 p-3 rounded-lg border-blue-900 font-bold text-lg tracking-wider">
            </div>

            <button onclick="calculatePrize()" class="tc-bg-red text-white font-bold py-3 px-4 rounded-lg w-full hover:bg-red-700 transition text-lg shadow-lg">
                ğŸ¯ ç«‹å³å°ç
            </button>
            
            <div id="result-box" class="mt-6 p-4 rounded-lg hidden shadow-inner border"></div>
        </div>
    </div>

    <script>
        // ä½ å°ˆå±¬çš„ Google Sheet CSV API ç¶²å€ï¼
        const GOOGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR7ZS9Nt-Y0kMHr_6lNy5FcMeYRn1_MVkmN_E3SuFDSxm7QkVT76NmeLkCWJNrR24U8XVtdTtn8IQc3/pub?output=csv";

        // å€’æ•¸è¨ˆæ™‚å™¨é‚è¼¯
        function updateTime() {
            let now = new Date();
            let min = now.getMinutes();
            let nextMin = Math.ceil((min + 1) / 5) * 5;
            let remainMin = nextMin - min - 1;
            let remainSec = 60 - now.getSeconds();
            if(remainSec === 60) { remainMin += 1; remainSec = 0; }
            document.getElementById('timer').innerText = 
                String(remainMin).padStart(2, '0') + ":" + String(remainSec).padStart(2, '0');
        }
        setInterval(updateTime, 1000); updateTime();

        // æ ¸å¿ƒè³‡æ–™èˆ‡çé‡‘è¡¨
        let globalBingoData = [];
        const PRIZE_TABLE = {
            1: {1: 50}, 2: {2: 75}, 3: {3: 500, 2: 50}, 4: {4: 1000, 3: 100, 2: 25},
            5: {5: 7500, 4: 500, 3: 50}, 6: {6: 25000, 5: 1000, 4: 200, 3: 25},
            7: {7: 80000, 6: 3000, 5: 300, 4: 50, 3: 25}, 8: {8: 500000, 7: 20000, 6: 1000, 5: 400, 4: 100, 0: 25},
            9: {9: 1000000, 8: 100000, 7: 3000, 6: 500, 5: 100, 4: 25, 0: 25}, 10: {10: 5000000, 9: 250000, 8: 25000, 7: 2500, 6: 250, 5: 25, 0: 25}
        };

        // è§£æ Google è©¦ç®—è¡¨ CSV çš„å¼•æ“
        async function fetchGoogleSheetData() {
            try {
                // åŠ ä¸Šæ™‚é–“æˆ³é˜²æ­¢ç€è¦½å™¨å¿«å–èˆŠè³‡æ–™
                const response = await fetch(GOOGLE_CSV_URL + "&t=" + new Date().getTime());
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\\n');
                let tempData = [];
                
                // å¾ç¬¬äºŒè¡Œé–‹å§‹è®€å– (è·³éæ¨™é¡Œ)
                for(let i = 1; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if(!line) continue;
                    
                    // è§£æ CSV æ ¼å¼ (æœŸæ•¸, æ™‚é–“, "è™Ÿç¢¼, è™Ÿç¢¼...")
                    let firstComma = line.indexOf(',');
                    let secondComma = line.indexOf(',', firstComma + 1);
                    
                    let draw_id = line.substring(0, firstComma).trim();
                    let time = line.substring(firstComma + 1, secondComma).trim();
                    // å»é™¤è™Ÿç¢¼å¤–åœçš„é›™å¼•è™Ÿ
                    let numbersStr = line.substring(secondComma + 1).replace(/(^"|"$)/g, ''); 
                    let numbers = numbersStr.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                    
                    if(numbers.length === 20 && draw_id) {
                        tempData.push({ draw_id, time, numbers });
                    }
                }

                if(tempData.length > 0) {
                    globalBingoData = tempData;
                    document.getElementById('status-box').className = "p-3 rounded-lg bg-green-100 text-green-800 text-center font-bold shadow";
                    document.getElementById('status-box').innerHTML = `ğŸŸ¢ å®Œç¾é€£ç·š | è©¦ç®—è¡¨ç›®å‰å„²å­˜äº† ${globalBingoData.length} æœŸè³‡æ–™`;
                    
                    // è‡ªå‹•å¡«å…¥æœ€æ–°ä¸€æœŸ
                    document.getElementById('start-draw').value = globalBingoData[0].draw_id;

                    // æ¸²æŸ“è™Ÿç¢¼å¡ç‰‡ (é¡¯ç¤ºæœ€æ–° 6 æœŸ)
                    let html = '';
                    globalBingoData.slice(0, 6).forEach(draw => {
                        let nums = draw.numbers.map(n => String(n).padStart(2, '0')).join(', ');
                        html += `<div class="p-4 border rounded-xl bg-white shadow-sm hover:shadow-md transition"><div class="font-bold tc-red text-lg mb-1">ç¬¬ ${draw.draw_id} æœŸ <span class="text-sm text-gray-500 font-normal ml-2">ğŸ•’ ${draw.time}</span></div><div class="text-lg font-mono tracking-widest leading-relaxed text-gray-800 bg-gray-50 p-2 rounded">${nums}</div></div>`;
                    });
                    document.getElementById('draws-container').innerHTML = html;
                } else {
                    throw new Error("è©¦ç®—è¡¨å…§å°šç„¡æœ‰æ•ˆè³‡æ–™");
                }
            } catch (error) {
                document.getElementById('status-box').className = "p-3 rounded-lg bg-red-100 text-red-800 text-center font-bold shadow animate-pulse";
                document.getElementById('status-box').innerHTML = `ğŸ”´ ç„¡æ³•è®€å–è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèª Google Sheet æ˜¯å¦è¨­å®šç‚ºå…¬é–‹ä¸¦ç™¼ä½ˆã€‚`;
            }
        }

        // å°çè¨ˆç®—é‚è¼¯
        function calculatePrize() {
            const star = parseInt(document.getElementById('star-select').value);
            const mult = parseInt(document.getElementById('multiplier').value);
            const counts = parseInt(document.getElementById('draw-counts').value);
            const startId = parseInt(document.getElementById('start-draw').value);
            
            // æ¸…ç†ä½¿ç”¨è€…è¼¸å…¥çš„è™Ÿç¢¼
            const userNums = document.getElementById('user-numbers').value
                .replace(/\\s+/g, '')
                .split(/[,ï¼Œã€]/) // æ”¯æ´ä¸­è‹±æ–‡é€—è™Ÿèˆ‡é “è™Ÿ
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));

            const resBox = document.getElementById('result-box');
            resBox.classList.remove('hidden');

            if(userNums.length !== star) {
                resBox.className = "mt-6 p-4 rounded-lg bg-red-50 text-red-800 border border-red-300 shadow-inner";
                resBox.innerHTML = `âš ï¸ éŒ¯èª¤ï¼šæ‚¨é¸æ“‡äº† ${star} æ˜Ÿç©æ³•ï¼Œä½†ç›®å‰è¼¸å…¥äº† ${userNums.length} å€‹æœ‰æ•ˆæ•¸å­—ã€‚<br>è«‹ç¢ºä¿æ•¸å­—ä¹‹é–“ç”¨é€—è™Ÿéš”é–‹ã€‚`;
                return;
            }

            let totalPrize = 0;
            let matchLog = [];

            // å¾èµ·å§‹æœŸæ•¸å¾€å¾Œæ¨ç®—
            for(let i=0; i<counts; i++) {
                let targetId = String(startId + i);
                let drawData = globalBingoData.find(d => d.draw_id === targetId);
                
                if(drawData) {
                    let matched = userNums.filter(n => drawData.numbers.includes(n));
                    let matchCount = matched.length;
                    let basePrize = (PRIZE_TABLE[star][matchCount] || 0);
                    let finalPrize = basePrize * mult;
                    totalPrize += finalPrize;
                    
                    let matchNumStr = matched.length > 0 ? `(${matched.map(n=>String(n).padStart(2,'0')).join(', ')})` : '';
                    let prizeClass = finalPrize > 0 ? "font-bold text-red-600 text-lg" : "text-gray-500";
                    let rowBg = finalPrize > 0 ? "bg-red-50" : "bg-white";
                    
                    matchLog.push(`<div class="border-b px-3 py-3 flex justify-between items-center ${rowBg}">
                        <span>ç¬¬ ${targetId} æœŸï¼šä¸­ ${matchCount} é¡† <span class="text-xs text-gray-500">${matchNumStr}</span></span> 
                        <span class="${prizeClass}">$${finalPrize}</span>
                    </div>`);
                } else {
                    matchLog.push(`<div class="border-b px-3 py-3 flex justify-between items-center bg-gray-50 text-gray-400">
                        <span>ç¬¬ ${targetId} æœŸï¼šå°šæœªé–‹çæˆ–æŸ¥ç„¡è³‡æ–™</span> 
                        <span>--</span>
                    </div>`);
                }
            }

            let totalCost = 25 * mult * counts;
            let profit = totalPrize - totalCost;
            let profitHtml = profit > 0 
                ? `<span class="text-green-600 font-bold bg-green-100 px-2 py-1 rounded">æ·¨è³º $${profit}</span>` 
                : `<span class="text-gray-600 font-bold">æ·¨æ $${profit}</span>`;

            resBox.className = "mt-6 p-5 rounded-xl bg-blue-50 border border-blue-200 shadow-inner";
            resBox.innerHTML = `
                <h3 class="font-bold text-xl mb-3 text-blue-900 border-b border-blue-200 pb-2">çµç®—æ˜ç´°è¡¨ <span class="text-sm font-normal text-gray-500">(ç¸½æˆæœ¬: $${totalCost})</span></h3>
                <div class="text-2xl font-bold mb-4 flex items-center gap-4">
                    ç¸½ç²å¾—çé‡‘ï¼š<span class="tc-red text-3xl">$${totalPrize}</span> ${profitHtml}
                </div>
                <div class="max-h-64 overflow-y-auto bg-white rounded-lg border shadow-sm text-sm">${matchLog.join('')}</div>
            `;
            
            // è‡ªå‹•æ»¾å‹•åˆ°çµæœå€
            resBox.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }

        // ç¶²é è¼‰å…¥å¾Œé¦¬ä¸ŠæŠ“è³‡æ–™ï¼Œä¸¦ä¸”æ¯ 30 ç§’èƒŒæ™¯åˆ·æ–°ä¸€æ¬¡ Google Sheet
        fetchGoogleSheetData();
        setInterval(fetchGoogleSheetData, 30000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Bingo çµ‚æ¥µå…¨ç©æ³•çµ‚ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tc-red { color: #E63946; }
        .tc-bg-red { background-color: #E63946; }
        .tc-bg-dark { background-color: #0A1931; }
        .num-btn.selected { background-color: #E63946; color: white; border-color: #F1C40F; transform: scale(1.1); }
        .tab-active { border-bottom: 4px solid #F1C40F; color: #F1C40F; font-weight: bold; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-10">

    <nav class="tc-bg-dark text-white sticky top-0 z-50 shadow-xl">
        <div class="flex justify-around items-center p-3 text-sm font-bold">
            <a href="#bet-section" class="tab-active py-1 px-2">ğŸ¯ æŠ•æ³¨å°ç</a>
            <a href="#history-section" class="py-1 px-2">ğŸ“Š é–‹çç´€éŒ„</a>
            <a href="#stats-section" class="py-1 px-2">ğŸ”¥ å†·ç†±è¶¨å‹¢</a>
        </div>
        <div class="bg-blue-900/50 p-2 flex justify-center items-center gap-4 border-t border-white/10">
            <span class="text-xs">â³ ä¸‹æœŸé–‹çå€’æ•¸ï¼š</span>
            <span id="timer" class="text-yellow-400 font-mono font-bold text-2xl">--:--</span>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 space-y-6">
        
        <div id="status-box" class="p-3 rounded-xl bg-white text-center font-bold shadow-sm border text-gray-500">
            ğŸ”„ è®€å– Google è©¦ç®—è¡¨è³‡æ–™ä¸­...
        </div>

        <div id="bet-section" class="bg-white rounded-2xl shadow-lg border-t-8 border-red-600 overflow-hidden">
            <div class="p-5 bg-red-50 border-b">
                <h2 class="text-2xl font-black tc-red flex items-center gap-2">ğŸ“ æŠ•æ³¨èˆ‡å°çè©¦ç®—</h2>
            </div>
            
            <div class="p-5 space-y-6">
                <div class="grid grid-cols-3 gap-2 p-1 bg-gray-100 rounded-xl">
                    <button onclick="changeMode('star')" id="btn-star" class="py-2 rounded-lg font-bold bg-white shadow">æ˜Ÿè™Ÿ</button>
                    <button onclick="changeMode('bs')" id="btn-bs" class="py-2 rounded-lg font-bold text-gray-500">å¤§å°</button>
                    <button onclick="changeMode('oe')" id="btn-oe" class="py-2 rounded-lg font-bold text-gray-500">å–®é›™</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div id="star-select-div">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç©æ³•æ˜Ÿæ•¸</label>
                        <select id="star-select" onchange="resetSelection()" class="w-full border p-3 rounded-xl bg-gray-50 font-bold">
                            <option value="1">1æ˜Ÿ</option><option value="2">2æ˜Ÿ</option><option value="3" selected>3æ˜Ÿ</option>
                            <option value="4">4æ˜Ÿ</option><option value="5">5æ˜Ÿ</option><option value="6">6æ˜Ÿ</option>
                            <option value="7">7æ˜Ÿ</option><option value="8">8æ˜Ÿ</option><option value="9">9æ˜Ÿ</option><option value="10">10æ˜Ÿ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å€æ•¸</label>
                        <input type="number" id="multiplier" value="4" min="1" class="w-full border p-3 rounded-xl bg-gray-50 font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é€£çºŒæœŸæ•¸</label>
                        <input type="number" id="draw-counts" value="10" min="1" class="w-full border p-3 rounded-xl bg-gray-50 font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">èµ·å§‹æœŸæ•¸</label>
                        <input type="text" id="start-draw" placeholder="ä¾‹: 115011765" class="w-full border p-3 rounded-xl bg-gray-50 font-bold text-center">
                    </div>
                </div>

                <div id="star-picker-div">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold">æŒ‘é¸è™Ÿç¢¼ (é»æ“Šé¸æ“‡)</span>
                        <span id="select-count" class="tc-red font-bold text-sm">å·²é¸ 0 å€‹</span>
                    </div>
                    <div id="num-grid" class="grid grid-cols-10 gap-1 sm:gap-2">
                        </div>
                </div>

                <div id="bs-oe-picker-div" class="hidden">
                    <label class="block text-sm font-bold mb-2">è«‹é¸æ“‡æŠ•æ³¨é …</label>
                    <div id="bs-options" class="grid grid-cols-2 gap-4">
                        <button onclick="pickOption('å¤§')" class="opt-btn p-4 border-2 rounded-xl font-bold">å¤§ (41~80)</button>
                        <button onclick="pickOption('å°')" class="opt-btn p-4 border-2 rounded-xl font-bold">å° (01~40)</button>
                    </div>
                    <div id="oe-options" class="hidden grid grid-cols-5 gap-1">
                        <button onclick="pickOption('å–®')" class="opt-btn p-2 border rounded-lg text-xs font-bold">å–®</button>
                        <button onclick="pickOption('é›™')" class="opt-btn p-2 border rounded-lg text-xs font-bold">é›™</button>
                        <button onclick="pickOption('å°å–®')" class="opt-btn p-2 border rounded-lg text-xs font-bold">å°å–®</button>
                        <button onclick="pickOption('å°é›™')" class="opt-btn p-2 border rounded-lg text-xs font-bold">å°é›™</button>
                        <button onclick="pickOption('å’Œ')" class="opt-btn p-2 border rounded-lg text-xs font-bold">å’Œ</button>
                    </div>
                </div>

                <button onclick="calculatePrize()" class="tc-bg-red text-white font-black py-4 px-4 rounded-2xl w-full text-xl shadow-lg active:scale-95 transition-transform">
                    ğŸ¯ ç«‹å³å°ç
                </button>
                
                <div id="result-box" class="hidden rounded-2xl overflow-hidden"></div>
            </div>
        </div>

        <div id="history-section" class="bg-white rounded-2xl shadow p-5 border-l-8 border-gray-400">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“Š è¿‘æœŸé–‹çç´€éŒ„</h2>
            <div id="draws-container" class="space-y-3"></div>
        </div>

        <div id="stats-section" class="bg-white rounded-2xl shadow p-5 border-l-8 border-yellow-500">
            <h2 class="text-xl font-bold mb-4">ğŸ”¥ æ•¸æ“šçµ±è¨ˆ (æœ€æ–°200æœŸ)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-red-600 mb-2">æœ€ç†±é–€è™Ÿç¢¼ Top 10</h3>
                    <div id="hot-nums" class="space-y-1"></div>
                </div>
                <div>
                    <h3 class="font-bold text-blue-600 mb-2">æœ€å†·é–€è™Ÿç¢¼ Top 10</h3>
                    <div id="cold-nums" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¦³å°ˆå±¬çš„ CSV ç¶²å€
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR7ZS9Nt-Y0kMHr_6lNy5FcMeYRn1_MVkmN_E3SuFDSxm7QkVT76NmeLkCWJNrR24U8XVtdTtn8IQc3/pub?gid=1857522434&single=true&output=csv";

        let globalBingoData = [];
        let selectedNumbers = [];
        let currentGameMode = 'star';
        let selectedOption = null;

        const STAR_PRIZES = {
            1: {1: 50}, 2: {2: 75}, 3: {3: 500, 2: 50}, 4: {4: 1000, 3: 100, 2: 25},
            5: {5: 7500, 4: 500, 3: 50}, 6: {6: 25000, 5: 1000, 4: 200, 3: 25},
            7: {7: 80000, 6: 3000, 5: 300, 4: 50, 3: 25},
            8: {8: 500000, 7: 20000, 6: 1000, 5: 400, 4: 100, 0: 25},
            9: {9: 1000000, 8: 100000, 7: 3000, 6: 500, 5: 100, 4: 25, 0: 25},
            10: {10: 5000000, 9: 250000, 8: 25000, 7: 2500, 6: 250, 5: 25, 0: 25}
        };

        // é é¢åˆå§‹åŒ–
        function init() {
            const grid = document.getElementById('num-grid');
            for(let i=1; i<=80; i++) {
                let btn = document.createElement('button');
                btn.innerText = String(i).padStart(2, '0');
                btn.className = "num-btn border p-2 rounded-lg text-sm font-bold bg-white hover:bg-gray-100";
                btn.onclick = () => toggleNumber(i, btn);
                grid.appendChild(btn);
            }
            fetchData();
            setInterval(updateCountdown, 1000);
            setInterval(fetchData, 60000);
        }

        function toggleNumber(num, btn) {
            const limit = parseInt(document.getElementById('star-select').value);
            if(selectedNumbers.includes(num)) {
                selectedNumbers = selectedNumbers.filter(n => n !== num);
                btn.classList.remove('selected');
            } else if(selectedNumbers.length < limit) {
                selectedNumbers.push(num);
                btn.classList.add('selected');
            }
            document.getElementById('select-count').innerText = `å·²é¸ ${selectedNumbers.length} / ${limit} å€‹`;
        }

        function changeMode(mode) {
            currentGameMode = mode;
            document.querySelectorAll('#btn-star, #btn-bs, #btn-oe').forEach(b => {
                b.classList.remove('bg-white', 'shadow');
                b.classList.add('text-gray-500');
            });
            document.getElementById(`btn-${mode}`).classList.add('bg-white', 'shadow');
            document.getElementById(`btn-${mode}`).classList.remove('text-gray-500');

            document.getElementById('star-picker-div').style.display = (mode === 'star') ? 'block' : 'none';
            document.getElementById('star-select-div').style.display = (mode === 'star') ? 'block' : 'none';
            document.getElementById('bs-oe-picker-div').style.display = (mode !== 'star') ? 'block' : 'none';
            document.getElementById('bs-options').classList.toggle('hidden', mode !== 'bs');
            document.getElementById('oe-options').classList.toggle('hidden', mode !== 'oe');
        }

        function pickOption(opt) {
            selectedOption = opt;
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('tc-bg-red', 'text-white', 'border-red-600'));
            event.target.classList.add('tc-bg-red', 'text-white', 'border-red-600');
        }

        async function fetchData() {
            try {
                const res = await fetch(CSV_URL + "&t=" + Date.now());
                const text = await res.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                let data = [];
                for(let i=1; i<lines.length; i++){
                    let p = lines[i].split(/,(.+)/);
                    let id = p[0].trim();
                    let rest = p[1].split(/,(.+)/);
                    let time = rest[0].trim();
                    let nums = rest[1].replace(/"/g, '').split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                    if(nums.length === 20) data.push({ id, time, nums });
                }
                globalBingoData = data;
                renderHistory();
                renderStats();
                document.getElementById('status-box').innerHTML = `ğŸŸ¢ é€£ç·šæ­£å¸¸ | å·²åŒæ­¥ ${data.length} æœŸè³‡æ–™`;
                if(data[0]) document.getElementById('start-draw').value = data[0].id;
            } catch (e) { document.getElementById('status-box').innerText = "ğŸ”´ é€£ç·šå¤±æ•—"; }
        }

        function calculatePrize() {
            const mult = parseInt(document.getElementById('multiplier').value);
            const count = parseInt(document.getElementById('draw-counts').value);
            const startId = parseInt(document.getElementById('start-draw').value);
            const starCount = parseInt(document.getElementById('star-select').value);
            
            if(currentGameMode === 'star' && selectedNumbers.length !== starCount) return alert(`è«‹é¸æ»¿ ${starCount} å€‹è™Ÿç¢¼`);
            if(currentGameMode !== 'star' && !selectedOption) return alert("è«‹é¸æ“‡æŠ•æ³¨é¸é …");

            let totalCost = 25 * mult * count;
            let totalWin = 0;
            let log = '';

            for(let i=0; i<count; i++) {
                let id = String(startId + i);
                let draw = globalBingoData.find(d => d.id === id);
                let win = 0;
                let detail = '';

                if(draw) {
                    if(currentGameMode === 'star') {
                        let matches = selectedNumbers.filter(n => draw.nums.includes(n));
                        win = (STAR_PRIZES[starCount][matches.length] || 0) * mult;
                        detail = `ä¸­ ${matches.length} é¡†`;
                    } else if(currentGameMode === 'bs') {
                        let bigs = draw.nums.filter(n => n >= 41).length;
                        let result = bigs >= 13 ? "å¤§" : (bigs <= 7 ? "å°" : "ç„¡");
                        if(selectedOption === result) win = 150 * mult;
                        detail = `é–‹å‡º: ${result} (å¤§${bigs})`;
                    } else if(currentGameMode === 'oe') {
                        let odds = draw.nums.filter(n => n % 2 !== 0).length;
                        let result = odds >= 13 ? "å–®" : (odds <= 7 ? "é›™" : (odds === 11 || odds === 12 ? "å°å–®" : (odds === 8 || odds === 9 ? "å°é›™" : "å’Œ")));
                        if(selectedOption === result) win = result === "å’Œ" ? 70 * mult : (result.includes("å°") ? 45 * mult : 150 * mult);
                        detail = `é–‹å‡º: ${result} (å–®${odds})`;
                    }
                }
                totalWin += win;
                log += `<div class="p-3 border-b flex justify-between items-center ${win > 0 ? 'bg-red-50' : 'text-gray-400'}">
                    <span>${id}æœŸ | ${detail}</span>
                    <span class="font-bold ${win > 0 ? 'text-red-600' : ''}">$${win}</span>
                </div>`;
            }

            const box = document.getElementById('result-box');
            box.classList.remove('hidden');
            box.innerHTML = `
                <div class="p-4 bg-blue-900 text-white flex justify-between">
                    <span>ç¸½æ”¯å‡º: $${totalCost}</span>
                    <span class="text-yellow-300 font-bold">ç¸½çé‡‘: $${totalWin}</span>
                </div>
                <div class="bg-white p-2 text-sm">${log || "ç„¡ç´€éŒ„"}</div>
            `;
        }

        function renderHistory() {
            let html = '';
            globalBingoData.slice(0, 10).forEach(d => {
                html += `<div class="p-3 bg-gray-50 rounded-lg"><div class="text-xs font-bold text-gray-500">${d.id}æœŸ | ${d.time}</div><div class="text-sm font-mono tracking-tighter text-blue-900">${d.nums.join(',')}</div></div>`;
            });
            document.getElementById('draws-container').innerHTML = html;
        }

        function renderStats() {
            let counts = {};
            for(let i=1; i<=80; i++) counts[i] = 0;
            globalBingoData.slice(0, 200).forEach(d => d.nums.forEach(n => counts[n]++));
            
            let sorted = Object.keys(counts).map(n => ({ num: n, count: counts[n] }))
                .sort((a, b) => b.count - a.count);
            
            const createBar = (arr, target) => {
                target.innerHTML = arr.map(x => `<div class="flex items-center gap-2 text-xs">
                    <span class="w-6 font-bold">${String(x.num).padStart(2,'0')}</span>
                    <div class="flex-1 bg-gray-200 h-2 rounded-full overflow-hidden"><div class="bg-red-500 h-full" style="width:${(x.count/200*100*2)}%"></div></div>
                    <span class="w-10 text-right">${(x.count/200*100).toFixed(1)}%</span>
                </div>`).join('');
            };

            createBar(sorted.slice(0, 10), document.getElementById('hot-nums'));
            createBar(sorted.slice(-10).reverse(), document.getElementById('cold-nums'));
        }

        function updateCountdown() {
            let n = new Date();
            let next = Math.ceil((n.getMinutes() + 1) / 5) * 5;
            let m = next - n.getMinutes() - 1;
            let s = 60 - n.getSeconds();
            if(s === 60) { m++; s=0; }
            document.getElementById('timer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        window.onload = init;
    </script>
</body>
</html>
